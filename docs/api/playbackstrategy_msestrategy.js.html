<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Adding meta -->
    
    
    <meta name="description" content="Simplified media playback for bigscreen devices" />
    
    

    <!-- Adding external script-->
    

    <!-- Adding external style-->
    

    <!-- Adding scripts-->
    

    <!-- Adding style-->
    

    <!-- Adding overlay script-->
    

    <!-- Adding overlay style-->
    


    <title>
      playbackstrategy/msestrategy.js
    </title>

    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/third-party/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/third-party/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/reset.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-base.css">
    <link type="text/css" rel="stylesheet" href="styles/clean-jsdoc-theme-dark.css">
    
    <svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
    style="display:none">
    <defs>
        <symbol id="copy-icon" viewbox="0 0 488.3 488.3">
            <g>
                <path
                    d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z" />
                <path
                    d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z" />
            </g>
        </symbol>
        <symbol id='search-icon' viewBox="0 0 512 512">
            <g>
                <g>
                    <path
                        d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z" />
                </g>
            </g>
            <g>
                <g>
                    <path
                        d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z" />
                </g>
            </g>
        </symbol>
        <symbol id="down-icon" viewBox="0 0 16 16">
            <path 
                fill-rule="evenodd" 
                clip-rule="evenodd" 
                d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"
            >
            </path>
        </symbol>
    </defs>
</svg>
  </head>

  <body>

    <nav class="navbar" id="navbar">
      <h2><a href="index.html"><img src='bsp-logo.png'/></a></h2><div class="search-box" id="search-box"><div class="search-box-input-container"><input class="search-box-input" type="text" placeholder="Search..." id="search-box-input" /><svg class="search-icon" alt="search-icon"><use xlink:href="#search-icon"></use></svg></div><div class="search-item-container" id="search-item-container"><ul class="search-item-ul" id="search-item-ul"></ul></div></div><div class="sidebar-main-content" id="sidebar-main-content"><ul><li class="menu-li"><a href='https://github.com/bbc/bigscreen-player' class=' menu-link' id='' target='_blank'>Github</a></li><li class="menu-li"><a href='https://www.npmjs.com/package/bigscreen-player' class=' menu-link' id='' target='_blank'>NPM</a></li></ul><div class="accordion collapsed" id="3171051" > <h3 class="accordion-heading">Tutorials<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion-list" id=""><a href="tutorial-CDN Failover.html">CDN Failover</a></li><li class="accordion-list" id=""><a href="tutorial-Design.html">Design</a></li><li class="accordion-list" id=""><a href="tutorial-Events.html">Events</a></li><li class="accordion-list" id=""><a href="tutorial-Getting Started.html">Getting Started</a></li><li class="accordion-list" id=""><a href="tutorial-Mocking Playback.html">Mocking Playback</a></li><li class="accordion-list" id=""><a href="tutorial-Playback Strategies.html">Playback Strategies</a></li><li class="accordion-list" id=""><a href="tutorial-Plugins.html">Plugins</a></li><li class="accordion-list" id=""><a href="tutorial-Testing.html">Testing</a></li></ul> </div><div class="accordion collapsed" id="6622497" > <h3 class="accordion-heading">Modules<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion collapsed child" id=6609897><div class="accordion-heading child"><a href="module-bigscreenplayer_bigscreenplayer.html">bigscreenplayer/bigscreenplayer</a><svg><use xlink:href="#down-icon"></use></svg></div><ul class='methods accordion-content'><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.canPause">canPause</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.canSeek">canSeek</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.convertEpochMsToVideoTimeSeconds">convertEpochMsToVideoTimeSeconds</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.convertVideoTimeSecondsToEpochMs">convertVideoTimeSecondsToEpochMs</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.getCurrentTime">getCurrentTime</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.getDuration">getDuration</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.getFrameworkVersion">getFrameworkVersion</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.getLiveWindowData">getLiveWindowData</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.getLogLevels">getLogLevels</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.getMediaKind">getMediaKind</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.getPlayerElement">getPlayerElement</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.getSeekableRange">getSeekableRange</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.getWindowType">getWindowType</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.isEnded">isEnded</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.isPaused">isPaused</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.isPlayingAtLiveEdge">isPlayingAtLiveEdge</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.isSubtitlesAvailable">isSubtitlesAvailable</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.isSubtitlesEnabled">isSubtitlesEnabled</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.mock">mock</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.mockJasmine">mockJasmine</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.pause">pause</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.play">play</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.registerForStateChanges">registerForStateChanges</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.registerForSubtitleChanges">registerForSubtitleChanges</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.registerForTimeUpdates">registerForTimeUpdates</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.registerPlugin">registerPlugin</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.setCurrentTime">setCurrentTime</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.setLogLevel">setLogLevel</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.setSubtitlesEnabled">setSubtitlesEnabled</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.setTransportControlsPosition">setTransportControlsPosition</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.toggleDebug">toggleDebug</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.transitions">transitions</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.unmock">unmock</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.unregisterForStateChanges">unregisterForStateChanges</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.unregisterForSubtitleChanges">unregisterForSubtitleChanges</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.unregisterForTimeUpdates">unregisterForTimeUpdates</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#.unregisterPlugin">unregisterPlugin</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#~getLiveSupport">getLiveSupport</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#~init">init</a></li><li data-type='method'><a href="module-bigscreenplayer_bigscreenplayer.html#~tearDown">tearDown</a></li></ul></li></ul> </div><div class="accordion collapsed" id="85886" > <h3 class="accordion-heading">Global<svg><use xlink:href="#down-icon"></use></svg></h3><ul class="accordion-content"><li class="accordion-list" id=""><a href="global.html#hasAttribute">hasAttribute</a></li><li class="accordion-list" id=""><a href="global.html#rgbaToRGB">rgbaToRGB</a></li><li class="accordion-list" id=""><a href="global.html#safeRemoveElement">safeRemoveElement</a></li><li class="accordion-list" id=""><a href="global.html#Time">Time</a></li><li class="accordion-list" id=""><a href="global.html#WindowTypes">WindowTypes</a></li></ul> </div></div>
      

    </nav>
    <div class="navbar-ham" id="navbar-ham">
      <div>
        <div class="first"></div>
        <div class="second"></div>
        <div class="third"></div>
      </div>
    </div>

    <div id="main" class="main-content">
      
      <h1 id='page-title' class="page-title">
        playbackstrategy/msestrategy.js
      </h1>
      

      



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import MediaState from '../models/mediastate'
import WindowTypes from '../models/windowtypes'
import DebugTool from '../debugger/debugtool'
import MediaKinds from '../models/mediakinds'
import Plugins from '../plugins'
import ManifestModifier from '../manifest/manifestmodifier'
import LiveSupport from '../models/livesupport'
import DynamicWindowUtils from '../dynamicwindowutils'
import TimeUtils from '../utils/timeutils'
import DOMHelpers from '../domhelpers'
import Utils from '../utils/playbackutils'
import { MediaPlayer } from 'dashjs/index_mediaplayerOnly'

function MSEStrategy (mediaSources, windowType, mediaKind, playbackElement, isUHD, customPlayerSettings) {
  const LIVE_DELAY_SECONDS = 1.1

  let mediaPlayer
  let mediaElement

  let eventCallbacks = []
  let errorCallback
  let timeUpdateCallback

  let timeCorrection = mediaSources.time() &amp;&amp; mediaSources.time().correction || 0
  let failoverTime
  let refreshFailoverTime
  let slidingWindowPausedTime = 0
  let isEnded = false

  let dashMetrics

  let publishedSeekEvent = false
  let isSeeking = false

  let playerMetadata = {
    playbackBitrate: undefined,
    bufferLength: undefined,
    fragmentInfo: {
      requestTime: undefined,
      numDownloaded: undefined
    }
  }

  const DashJSEvents = {
    LOG: 'log',
    ERROR: 'error',
    MANIFEST_LOADED: 'manifestLoaded',
    DOWNLOAD_MANIFEST_ERROR_CODE: 25,
    DOWNLOAD_SIDX_ERROR_CODE: 26,
    DOWNLOAD_CONTENT_ERROR_CODE: 27,
    DOWNLOAD_INIT_SEGMENT_ERROR_CODE: 28,
    MANIFEST_VALIDITY_CHANGED: 'manifestValidityChanged',
    QUALITY_CHANGE_RENDERED: 'qualityChangeRendered',
    BASE_URL_SELECTED: 'baseUrlSelected',
    SERVICE_LOCATION_AVAILABLE: 'serviceLocationUnblacklisted',
    URL_RESOLUTION_FAILED: 'urlResolutionFailed',
    METRIC_ADDED: 'metricAdded',
    METRIC_CHANGED: 'metricChanged',
    STREAM_INITIALIZED: 'streamInitialized'
  }

  function onPlaying () {
    isEnded = false
    publishMediaState(MediaState.PLAYING)
  }

  function onPaused () {
    publishMediaState(MediaState.PAUSED)
  }

  function onBuffering () {
    isEnded = false
    if (!isSeeking || !publishedSeekEvent) {
      publishMediaState(MediaState.WAITING)
      publishedSeekEvent = true
    }
  }

  function onSeeked () {
    isSeeking = false
    DebugTool.info('Seeked Event')

    if (isPaused()) {
      if (windowType === WindowTypes.SLIDING) {
        startAutoResumeTimeout()
      }
      publishMediaState(MediaState.PAUSED)
    } else {
      publishMediaState(MediaState.PLAYING)
    }
  }

  function onEnded () {
    isEnded = true
    publishMediaState(MediaState.ENDED)
  }

  function onTimeUpdate () {
    const IN_STREAM_BUFFERING_SECONDS = 20
    const dvrInfo = mediaPlayer.getDashMetrics().getCurrentDVRInfo('video')

    if (dvrInfo &amp;&amp; windowType === WindowTypes.SLIDING) {
      failoverTime = Math.max(0, parseInt(dvrInfo.time - dvrInfo.range.start) - IN_STREAM_BUFFERING_SECONDS)
    } else {
      const time = mediaElement.currentTime

      // Note: Multiple consecutive CDN failover logic
      // A newly loaded video element will always report a 0 time update
      // This is slightly unhelpful if we want to continue from a later point but consult failoverTime as the source of truth.
      if (parseInt(time) !== 0) {
        failoverTime = time
      }
    }

    publishTimeUpdate()
  }

  function onError (event) {
    if (event.error &amp;&amp; event.error.data) {
      delete event.error.data
    }

    if (event.error &amp;&amp; event.error.message) {
      DebugTool.info('MSE Error: ' + event.error.message)

      // Don't raise an error on fragment download error
      if (event.error.code === DashJSEvents.DOWNLOAD_SIDX_ERROR_CODE ||
        event.error.code === DashJSEvents.DOWNLOAD_CONTENT_ERROR_CODE ||
        event.error.code === DashJSEvents.DOWNLOAD_INIT_SEGMENT_ERROR_CODE) {
        return
      }

      if (event.error.code === DashJSEvents.DOWNLOAD_MANIFEST_ERROR_CODE) {
        manifestDownloadError(event)
        return
      }
    }
    publishError()
  }

  function manifestDownloadError (event) {
    const error = () => publishError()

    const failoverParams = {
      errorMessage: 'manifest-refresh',
      isBufferingTimeoutError: false,
      currentTime: getCurrentTime(),
      duration: getDuration()
    }

    mediaSources.failover(load, error, failoverParams)
  }

  function onManifestLoaded (event) {
    DebugTool.info('Manifest loaded. Duration is: ' + event.data.mediaPresentationDuration)

    if (event.data) {
      const manifest = event.data
      const representationOptions = window.bigscreenPlayer.representationOptions || {}

      ManifestModifier.filter(manifest, representationOptions)
      ManifestModifier.generateBaseUrls(manifest, mediaSources.availableSources())
    }
  }

  function onManifestValidityChange (event) {
    DebugTool.info('Manifest validity changed. Duration is: ' + event.newDuration)
  }

  function onStreamInitialised () {
    const setMseDuration = window.bigscreenPlayer.overrides &amp;&amp; window.bigscreenPlayer.overrides.mseDurationOverride
    if (setMseDuration &amp;&amp; (windowType === WindowTypes.SLIDING || windowType === WindowTypes.GROWING)) {
      // Workaround for no setLiveSeekableRange/clearLiveSeekableRange
      mediaPlayer.setDuration(Number.MAX_SAFE_INTEGER)
    }

    mediaPlayer.setBlacklistExpiryTime(mediaSources.failoverResetTime())
    emitPlayerInfo()
  }

  function emitPlayerInfo () {
    if (mediaKind === MediaKinds.VIDEO) {
      playerMetadata.playbackBitrate = currentPlaybackBitrate(MediaKinds.VIDEO) + currentPlaybackBitrate(MediaKinds.AUDIO)
    } else {
      playerMetadata.playbackBitrate = currentPlaybackBitrate(MediaKinds.AUDIO)
    }

    DebugTool.keyValue({ key: 'playback bitrate', value: playerMetadata.playbackBitrate + ' kbps' })

    Plugins.interface.onPlayerInfoUpdated({
      bufferLength: playerMetadata.bufferLength,
      playbackBitrate: playerMetadata.playbackBitrate
    })
  }

  function currentPlaybackBitrate (mediaKind) {
    const representationSwitch = mediaPlayer.getDashMetrics().getCurrentRepresentationSwitch(mediaKind)
    const representation = representationSwitch ? representationSwitch.to : ''
    return playbackBitrateForRepresentation(representation, mediaKind)
  }

  function playbackBitrateForRepresentation (representation, mediaKind) {
    const repIdx = mediaPlayer.getDashAdapter().getIndexForRepresentation(representation, 0)
    return playbackBitrateForRepresentationIndex(repIdx, mediaKind)
  }

  function playbackBitrateForRepresentationIndex (index, mediaKind) {
    if (index === -1) return ''

    const bitrateInfoList = mediaPlayer.getBitrateInfoListFor(mediaKind)
    return parseInt(bitrateInfoList[index].bitrate / 1000)
  }

  function onQualityChangeRendered (event) {
    function logBitrate (mediaKind, event) {
      const oldBitrate = isNaN(event.oldQuality) ? '--' : playbackBitrateForRepresentationIndex(event.oldQuality, mediaKind)
      const oldRepresentation = isNaN(event.oldQuality) ? 'Start' : event.oldQuality + ' (' + oldBitrate + ' kbps)'
      const newRepresentation = event.newQuality + ' (' + playbackBitrateForRepresentationIndex(event.newQuality, mediaKind) + ' kbps)'

      DebugTool.keyValue({ key: event.mediaType + ' Representation', value: newRepresentation })
      DebugTool.info(mediaKind + ' ABR Change Rendered From Representation ' + oldRepresentation + ' To ' + newRepresentation)
    }

    if (event.newQuality !== undefined) {
      logBitrate(event.mediaType, event)
    }

    emitPlayerInfo()
  }

  /**
   * Base url selected events are fired from dash.js whenever a priority weighted url is selected from a manifest
   * Note: we ignore the initial selection as it isn't a failover.
   * @param {*} event
   */
  function onBaseUrlSelected (event) {
    const failoverInfo = {
      errorMessage: 'download',
      isBufferingTimeoutError: false
    }

    function log () {
      DebugTool.info('BaseUrl selected: ' + event.baseUrl.url)
    }

    failoverInfo.serviceLocation = event.baseUrl.serviceLocation
    mediaSources.failover(log, log, failoverInfo)
  }

  function onServiceLocationAvailable (event) {
    DebugTool.info('Service Location available: ' + event.entry)
  }

  function onURLResolutionFailed () {
    DebugTool.info('URL Resolution failed')
  }

  function onMetricAdded (event) {
    if (event.mediaType === 'video') {
      if (event.metric === 'DroppedFrames') {
        DebugTool.keyValue({ key: 'Dropped Frames', value: event.value.droppedFrames })
      }
    }
    if (event.mediaType === mediaKind &amp;&amp; event.metric === 'BufferLevel') {
      dashMetrics = mediaPlayer.getDashMetrics()

      if (dashMetrics) {
        playerMetadata.bufferLength = dashMetrics.getCurrentBufferLevel(event.mediaType)
        DebugTool.keyValue({ key: 'Buffer Length', value: playerMetadata.bufferLength })
        Plugins.interface.onPlayerInfoUpdated({
          bufferLength: playerMetadata.bufferLength,
          playbackBitrate: playerMetadata.playbackBitrate
        })
      }
    }
    if (event.mediaType === mediaKind &amp;&amp; event.metric === 'HttpList' &amp;&amp; event.value._tfinish &amp;&amp; event.value.trequest) {
      playerMetadata.fragmentInfo.requestTime = Math.floor(Math.abs(event.value._tfinish.getTime() - event.value.trequest.getTime()))
      playerMetadata.fragmentInfo.numDownloaded = playerMetadata.fragmentInfo.numDownloaded ? ++playerMetadata.fragmentInfo.numDownloaded : 1
      Plugins.interface.onPlayerInfoUpdated({
        fragmentInfo: playerMetadata.fragmentInfo
      })
    }
  }

  function onDebugLog (e) {
    DebugTool.verbose(e.message)
  }

  function publishMediaState (mediaState) {
    for (let index = 0; index &lt; eventCallbacks.length; index++) {
      eventCallbacks[index](mediaState)
    }
  }

  function publishTimeUpdate () {
    if (timeUpdateCallback) {
      timeUpdateCallback()
    }
  }

  function publishError () {
    if (errorCallback) {
      errorCallback()
    }
  }

  function isPaused () {
    return (mediaPlayer &amp;&amp; mediaPlayer.isReady()) ? mediaPlayer.isPaused() : undefined
  }

  function getClampedTime (time, range) {
    return Math.min(Math.max(time, range.start), range.end - LIVE_DELAY_SECONDS)
  }

  function load (mimeType, playbackTime) {
    if (!mediaPlayer) {
      failoverTime = playbackTime
      setUpMediaElement(playbackElement)
      setUpMediaPlayer(playbackTime)
      setUpMediaListeners()
    } else {
      modifySource(refreshFailoverTime || failoverTime)
    }
  }

  function setUpMediaElement (playbackElement) {
    if (mediaKind === MediaKinds.AUDIO) {
      mediaElement = document.createElement('audio')
    } else {
      mediaElement = document.createElement('video')
    }

    mediaElement.style.position = 'absolute'
    mediaElement.style.width = '100%'
    mediaElement.style.height = '100%'

    playbackElement.insertBefore(mediaElement, playbackElement.firstChild)
  }

  function setUpMediaPlayer (playbackTime) {
    mediaPlayer = MediaPlayer().create()
    const playerSettings = Utils.merge({
      debug: {
        logLevel: 2
      },
      streaming: {
        liveDelay: LIVE_DELAY_SECONDS,
        bufferToKeep: 4,
        bufferTimeAtTopQuality: 12,
        bufferTimeAtTopQualityLongForm: 15
      }
    }, customPlayerSettings)
    mediaPlayer.updateSettings(playerSettings)
    mediaPlayer.initialize(mediaElement, null, true)
    modifySource(playbackTime)
  }

  function modifySource (playbackTime) {
    mediaPlayer.attachSource(calculateSourceAnchor(mediaSources.currentSource(), playbackTime))
  }

  function setUpMediaListeners () {
    mediaElement.addEventListener('timeupdate', onTimeUpdate)
    mediaElement.addEventListener('playing', onPlaying)
    mediaElement.addEventListener('pause', onPaused)
    mediaElement.addEventListener('waiting', onBuffering)
    mediaElement.addEventListener('seeking', onBuffering)
    mediaElement.addEventListener('seeked', onSeeked)
    mediaElement.addEventListener('ended', onEnded)
    mediaElement.addEventListener('error', onError)
    mediaPlayer.on(DashJSEvents.ERROR, onError)
    mediaPlayer.on(DashJSEvents.MANIFEST_LOADED, onManifestLoaded)
    mediaPlayer.on(DashJSEvents.STREAM_INITIALIZED, onStreamInitialised)
    mediaPlayer.on(DashJSEvents.MANIFEST_VALIDITY_CHANGED, onManifestValidityChange)
    mediaPlayer.on(DashJSEvents.QUALITY_CHANGE_RENDERED, onQualityChangeRendered)
    mediaPlayer.on(DashJSEvents.BASE_URL_SELECTED, onBaseUrlSelected)
    mediaPlayer.on(DashJSEvents.METRIC_ADDED, onMetricAdded)
    mediaPlayer.on(DashJSEvents.LOG, onDebugLog)
    mediaPlayer.on(DashJSEvents.SERVICE_LOCATION_AVAILABLE, onServiceLocationAvailable)
    mediaPlayer.on(DashJSEvents.URL_RESOLUTION_FAILED, onURLResolutionFailed)
  }

  /**
   * Calculates a source url with anchor tags for playback within dashjs
   *
   * Anchor tags applied to the MPD source for playback:
   *
   * #t - time since the beginning of the first period defined in the DASH manifest
   * @param {String} source
   * @param {Number} startTime
   */
  function calculateSourceAnchor (source, startTime) {
    if (startTime === undefined || isNaN(startTime)) {
      return source
    }

    startTime = parseInt(startTime)

    if (windowType === WindowTypes.STATIC) {
      return startTime === 0 ? source : source + '#t=' + startTime
    } else {
      const windowStartTimeSeconds = (mediaSources.time().windowStartTime / 1000)
      const srcWithTimeAnchor = source + '#t=posix:'

      return startTime === 0 ? srcWithTimeAnchor + (windowStartTimeSeconds + 1) : srcWithTimeAnchor + (windowStartTimeSeconds + startTime)
    }
  }

  function getSeekableRange () {
    if (mediaPlayer &amp;&amp; mediaPlayer.isReady() &amp;&amp; windowType !== WindowTypes.STATIC) {
      const dvrInfo = mediaPlayer.getDashMetrics().getCurrentDVRInfo(mediaKind)
      if (dvrInfo) {
        return {
          start: dvrInfo.range.start - timeCorrection,
          end: dvrInfo.range.end - timeCorrection
        }
      }
    }

    return {
      start: 0,
      end: getDuration()
    }
  }

  function getDuration () {
    return (mediaPlayer &amp;&amp; mediaPlayer.isReady()) ? mediaPlayer.duration() : 0
  }

  function getCurrentTime () {
    return (mediaElement) ? mediaElement.currentTime - timeCorrection : 0
  }

  function refreshManifestBeforeSeek (seekToTime) {
    refreshFailoverTime = seekToTime

    mediaPlayer.refreshManifest((manifest) => {
      const mediaPresentationDuration = manifest &amp;&amp; manifest.mediaPresentationDuration
      if (!isNaN(mediaPresentationDuration)) {
        DebugTool.info('Stream ended. Clamping seek point to end of stream')
        mediaPlayer.seek(getClampedTime(seekToTime, { start: getSeekableRange().start, end: mediaPresentationDuration }))
      } else {
        mediaPlayer.seek(seekToTime)
      }
    })
  }

  function calculateSeekOffset (time) {
    function getClampedTimeForLive (time) {
      return Math.min(Math.max(time, 0), mediaPlayer.getDVRWindowSize() - LIVE_DELAY_SECONDS)
    }

    if (windowType === WindowTypes.SLIDING) {
      const dvrInfo = mediaPlayer.getDashMetrics().getCurrentDVRInfo(mediaKind)
      const offset = TimeUtils.calculateSlidingWindowSeekOffset(time, dvrInfo.range.start, timeCorrection, slidingWindowPausedTime)
      slidingWindowPausedTime = 0

      return getClampedTimeForLive(offset)
    }
    return getClampedTime(time, getSeekableRange())
  }

  function addEventCallback (thisArg, newCallback) {
    const eventCallback = (event) => newCallback.call(thisArg, event)
    eventCallbacks.push(eventCallback)
  }

  function removeEventCallback (callback) {
    const index = eventCallbacks.indexOf(callback)
    if (index !== -1) {
      eventCallbacks.splice(index, 1)
    }
  }

  function startAutoResumeTimeout () {
    DynamicWindowUtils.autoResumeAtStartOfRange(
      getCurrentTime(),
      getSeekableRange(),
      addEventCallback,
      removeEventCallback,
      (event) => event !== MediaState.PAUSED,
      mediaPlayer.play)
  }

  return {
    transitions: {
      canBePaused: () => true,
      canBeginSeek: () => true
    },
    addEventCallback: addEventCallback,
    removeEventCallback: removeEventCallback,
    addErrorCallback: (thisArg, newErrorCallback) => {
      errorCallback = (event) => newErrorCallback.call(thisArg, event)
    },
    addTimeUpdateCallback: (thisArg, newTimeUpdateCallback) => {
      timeUpdateCallback = () => newTimeUpdateCallback.call(thisArg)
    },
    load: load,
    getSeekableRange: getSeekableRange,
    getCurrentTime: getCurrentTime,
    getDuration: getDuration,
    tearDown: () => {
      mediaPlayer.reset()

      mediaElement.removeEventListener('timeupdate', onTimeUpdate)
      mediaElement.removeEventListener('playing', onPlaying)
      mediaElement.removeEventListener('pause', onPaused)
      mediaElement.removeEventListener('waiting', onBuffering)
      mediaElement.removeEventListener('seeking', onBuffering)
      mediaElement.removeEventListener('seeked', onSeeked)
      mediaElement.removeEventListener('ended', onEnded)
      mediaElement.removeEventListener('error', onError)
      mediaPlayer.off(DashJSEvents.ERROR, onError)
      mediaPlayer.off(DashJSEvents.MANIFEST_LOADED, onManifestLoaded)
      mediaPlayer.off(DashJSEvents.MANIFEST_VALIDITY_CHANGED, onManifestValidityChange)
      mediaPlayer.off(DashJSEvents.STREAM_INITIALIZED, onStreamInitialised)
      mediaPlayer.off(DashJSEvents.QUALITY_CHANGE_RENDERED, onQualityChangeRendered)
      mediaPlayer.off(DashJSEvents.METRIC_ADDED, onMetricAdded)
      mediaPlayer.off(DashJSEvents.BASE_URL_SELECTED, onBaseUrlSelected)
      mediaPlayer.off(DashJSEvents.LOG, onDebugLog)
      mediaPlayer.off(DashJSEvents.SERVICE_LOCATION_AVAILABLE, onServiceLocationAvailable)
      mediaPlayer.off(DashJSEvents.URL_RESOLUTION_FAILED, onURLResolutionFailed)

      DOMHelpers.safeRemoveElement(mediaElement)

      mediaPlayer = undefined
      mediaElement = undefined
      eventCallbacks = []
      errorCallback = undefined
      timeUpdateCallback = undefined
      timeCorrection = undefined
      failoverTime = undefined
      isEnded = undefined
      dashMetrics = undefined
      playerMetadata = {
        playbackBitrate: undefined,
        bufferLength: undefined,
        fragmentInfo: {
          requestTime: undefined,
          numDownloaded: undefined
        }
      }
    },
    reset: () => {},
    isEnded: () => isEnded,
    isPaused: isPaused,
    pause: (opts) => {
      if (windowType === WindowTypes.SLIDING) {
        slidingWindowPausedTime = Date.now()
      }

      mediaPlayer.pause()
      opts = opts || {}
      if (opts.disableAutoResume !== true &amp;&amp; windowType === WindowTypes.SLIDING) {
        startAutoResumeTimeout()
      }
    },
    play: () => mediaPlayer.play(),
    setCurrentTime: (time) => {
      publishedSeekEvent = false
      isSeeking = true
      const seekToTime = getClampedTime(time, getSeekableRange())
      if (windowType === WindowTypes.GROWING &amp;&amp; seekToTime > getCurrentTime()) {
        refreshManifestBeforeSeek(seekToTime)
      } else {
        const seekTime = calculateSeekOffset(time)
        mediaPlayer.seek(seekTime)
      }
    },
    setPlaybackRate: (rate) => {
      mediaPlayer.setPlaybackRate(rate)
    },
    getPlaybackRate: () => {
      return mediaPlayer.getPlaybackRate()
    }
  }
}

MSEStrategy.getLiveSupport = () => LiveSupport.SEEKABLE

export default MSEStrategy
</code></pre>
        </article>
    </section>




    </div>

    <footer class="footer" id="footer">
      
    </footer>

    <script src="scripts/third-party/prettify.js"></script>
    <script src="scripts/third-party/lang-css.js"></script>
    <script type="text/javascript" src="scripts/misc.js"></script>

    <script>prettyPrint();</script>
    <script src="scripts/linenumber.js"></script>
    <script src="scripts/fix-code-block.js"></script>
    <script src="scripts/fix-navbar.js"></script>
    
      <script src="scripts/search.js"></script>
      <script src="scripts/third-party/fuse.js"></script>
      <script>
        var list = [{"title":"CDN Failover","link":"CDN Failover"},{"title":"Design","link":"Design"},{"title":"Events","link":"Events"},{"title":"Getting Started","link":"Getting Started"},{"title":"Mocking Playback","link":"Mocking Playback"},{"title":"Playback Strategies","link":"Playback Strategies"},{"title":"Plugins","link":"Plugins"},{"title":"Testing","link":"Testing"},{"title":"bigscreenplayer/bigscreenplayer","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html\">bigscreenplayer/bigscreenplayer</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.canPause","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.canPause\">module:bigscreenplayer/bigscreenplayer.canPause &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.canSeek","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.canSeek\">module:bigscreenplayer/bigscreenplayer.canSeek &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.convertEpochMsToVideoTimeSeconds","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.convertEpochMsToVideoTimeSeconds\">module:bigscreenplayer/bigscreenplayer.convertEpochMsToVideoTimeSeconds &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.convertVideoTimeSecondsToEpochMs","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.convertVideoTimeSecondsToEpochMs\">module:bigscreenplayer/bigscreenplayer.convertVideoTimeSecondsToEpochMs &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.getCurrentTime","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.getCurrentTime\">module:bigscreenplayer/bigscreenplayer.getCurrentTime &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.getDuration","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.getDuration\">module:bigscreenplayer/bigscreenplayer.getDuration &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.getFrameworkVersion","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.getFrameworkVersion\">module:bigscreenplayer/bigscreenplayer.getFrameworkVersion &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.getLiveWindowData","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.getLiveWindowData\">module:bigscreenplayer/bigscreenplayer.getLiveWindowData &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.getLogLevels","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.getLogLevels\">module:bigscreenplayer/bigscreenplayer.getLogLevels &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.getMediaKind","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.getMediaKind\">module:bigscreenplayer/bigscreenplayer.getMediaKind &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.getPlayerElement","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.getPlayerElement\">module:bigscreenplayer/bigscreenplayer.getPlayerElement &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.getSeekableRange","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.getSeekableRange\">module:bigscreenplayer/bigscreenplayer.getSeekableRange &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.getWindowType","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.getWindowType\">module:bigscreenplayer/bigscreenplayer.getWindowType &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.isEnded","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.isEnded\">module:bigscreenplayer/bigscreenplayer.isEnded &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.isPaused","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.isPaused\">module:bigscreenplayer/bigscreenplayer.isPaused &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.isPlayingAtLiveEdge","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.isPlayingAtLiveEdge\">module:bigscreenplayer/bigscreenplayer.isPlayingAtLiveEdge &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.isSubtitlesAvailable","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.isSubtitlesAvailable\">module:bigscreenplayer/bigscreenplayer.isSubtitlesAvailable &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.isSubtitlesEnabled","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.isSubtitlesEnabled\">module:bigscreenplayer/bigscreenplayer.isSubtitlesEnabled &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.mock","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.mock\">module:bigscreenplayer/bigscreenplayer.mock &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.mockJasmine","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.mockJasmine\">module:bigscreenplayer/bigscreenplayer.mockJasmine &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.pause","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.pause\">module:bigscreenplayer/bigscreenplayer.pause &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.play","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.play\">module:bigscreenplayer/bigscreenplayer.play &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.registerForStateChanges","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.registerForStateChanges\">module:bigscreenplayer/bigscreenplayer.registerForStateChanges &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.registerForSubtitleChanges","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.registerForSubtitleChanges\">module:bigscreenplayer/bigscreenplayer.registerForSubtitleChanges &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.registerForTimeUpdates","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.registerForTimeUpdates\">module:bigscreenplayer/bigscreenplayer.registerForTimeUpdates &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.registerPlugin","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.registerPlugin\">module:bigscreenplayer/bigscreenplayer.registerPlugin &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.setCurrentTime","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.setCurrentTime\">module:bigscreenplayer/bigscreenplayer.setCurrentTime &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.setLogLevel","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.setLogLevel\">module:bigscreenplayer/bigscreenplayer.setLogLevel &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.setSubtitlesEnabled","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.setSubtitlesEnabled\">module:bigscreenplayer/bigscreenplayer.setSubtitlesEnabled &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.setTransportControlsPosition","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.setTransportControlsPosition\">module:bigscreenplayer/bigscreenplayer.setTransportControlsPosition &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.toggleDebug","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.toggleDebug\">module:bigscreenplayer/bigscreenplayer.toggleDebug &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.transitions","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.transitions\">module:bigscreenplayer/bigscreenplayer.transitions &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.unmock","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.unmock\">module:bigscreenplayer/bigscreenplayer.unmock &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.unregisterForStateChanges","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.unregisterForStateChanges\">module:bigscreenplayer/bigscreenplayer.unregisterForStateChanges &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.unregisterForSubtitleChanges","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.unregisterForSubtitleChanges\">module:bigscreenplayer/bigscreenplayer.unregisterForSubtitleChanges &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.unregisterForTimeUpdates","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.unregisterForTimeUpdates\">module:bigscreenplayer/bigscreenplayer.unregisterForTimeUpdates &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer.unregisterPlugin","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#.unregisterPlugin\">module:bigscreenplayer/bigscreenplayer.unregisterPlugin &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer~getLiveSupport","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#~getLiveSupport\">module:bigscreenplayer/bigscreenplayer~getLiveSupport &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer~init","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#~init\">module:bigscreenplayer/bigscreenplayer~init &rtrif; undefined</a>"},{"title":"module:bigscreenplayer/bigscreenplayer~tearDown","link":"<a href=\"module-bigscreenplayer_bigscreenplayer.html#~tearDown\">module:bigscreenplayer/bigscreenplayer~tearDown &rtrif; undefined</a>"},{"title":"hasAttribute","link":"<a href=\"global.html#hasAttribute\">hasAttribute</a>"},{"title":"rgbaToRGB","link":"<a href=\"global.html#rgbaToRGB\">rgbaToRGB</a>"},{"title":"safeRemoveElement","link":"<a href=\"global.html#safeRemoveElement\">safeRemoveElement</a>"},{"title":"Time","link":"<a href=\"global.html#Time\">Time</a>"},{"title":"WindowTypes","link":"<a href=\"global.html#WindowTypes\">WindowTypes</a>"}];
        var options = {"shouldSort":true,"threshold":0.4,"location":0,"distance":100,"maxPatternLength":32,"minMatchCharLength":1}
          setupSearch(list, options)
      </script>
    

    

    

    

    


  </body>

</html>
